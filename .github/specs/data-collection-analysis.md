# データ収集・分析機能仕様書

> **Note**: このファイルはデータ収集とAI分析機能の仕様を定義します。

## データ収集機能

### 株価データ取得

- 株価データを Yahoo Finance API（RapidAPI 経由）から自動取得する。
- 日本株（.T、.JP サフィックス）と米国株の両方に対応。
- 銘柄コードの柔軟な入力：
  - 文字列形式（例：'7203.T'）と数値形式（例：7203）の両方をサポート
  - 4桁の数値は自動的に日本株として認識され、`.T`サフィックスが追加される
  - 通貨が未設定の場合、4桁数値は自動的に「円」と判定される

### ニュースデータ取得

- ニュースデータは defeatbeta-api を使用して実際のニュースを取得（最大5件）。
- 銘柄に関連する最新のニュース情報を収集。

### 銘柄リスト管理

- 対象銘柄リストはリポジトリ内の `data/stocks.yaml` ファイル（YAML形式）で管理。
- デフォルト値: '7203.T,6758.T'（ファイルが存在しない場合）
- 銘柄リストはYAML形式で管理し、銘柄コード、企業名、追加日、メモなどを構造化して記録可能。

**詳細な銘柄リスト管理仕様については <a>data-management.md</a> を参照してください。**

## AI分析機能

### 分析エンジン

- **Claude Sonnet API**（claude-3-sonnet-latest）または**Gemini API**（gemini-1.5-flash）を用いて、収集データの動向・トレンド・リスク/チャンスを日本語で要約・分析する。
- APIキー・モデル名は環境変数で管理。

### モデル選択

- **デフォルト**: `gemini-1.5-flash`（安定性と無料枠のバランスが良い）
- **環境変数 `GEMINI_MODEL`** で変更可能（例: `gemini-2.0-flash-exp`、`gemini-2.5-flash`）
- Claude使用時は `--claude` オプションまたは環境変数で切り替え

### API日次制限（Geminiのみ）

- **無料枠制限**: Gemini APIの無料枠は20リクエスト/日（2025年12月時点）
- **デフォルト処理数**: 18銘柄/日（余裕を持たせた設定）
- **環境変数 `GEMINI_DAILY_LIMIT`** で変更可能
- 銘柄数が制限を超える場合、日付ベースのローテーションで分散処理
  - 各実行日に異なる銘柄セットを分析し、全銘柄を順次カバー
  - 例: 74銘柄の場合、約4日で全銘柄を1巡
- **Claude APIは制限なし**（全銘柄を一度に処理）

### 多通貨対応

- 銘柄ごとに適切な通貨で分析を実施：
  - `currency`フィールドで明示的に指定された通貨を使用
  - 未指定の場合は銘柄シンボルから自動判定（日本株→円、その他→ドル）
  - 円、ドル、ユーロ、ポンドなど、任意の通貨に対応

### エラーハンドリング

- エラー発生時は、詳細なエラーメッセージ（例外内容、HTTPステータスコード、API応答など）をマークダウン形式で返し、メール本文に含める。

### 投資志向性の反映

ユーザーの投資スタイル、リスク許容度、投資期間などの志向性をAI分析のプロンプトに含め、個人の投資方針に合わせた分析を提供：

- **投資スタイル**：成長投資、バリュー投資、インカムゲイン投資、バランス投資、投機的投資から選択
- **リスク許容度**：低・中・高の3段階
- **投資期間**：短期・中期・長期
- **売買頻度の傾向**：頻繁・適度・少ない
- **重視する指標**：テクニカル分析、ファンダメンタル分析、ニュース、配当、モメンタムから複数選択可能
- **カスタムメッセージ**：追加の要望を自由記述

**詳細な投資志向性設定については <a>data-management.md</a> を参照してください。**

## 売買タイミング分析

### 保有状況の考慮

- 銘柄の保有状況（保有数、取得単価）を設定することで、AI が保有状況を考慮した売買判断を提供。

### 保有数の解釈

- **正の数**（例: 100）: 保有中の銘柄として、売却タイミングや買い増しの判断を提供
- **負の数**（例: -50）: 空売り中（信用売り）として、買戻しタイミングの判断を提供
- **未設定**: 購入または空売りを検討中として、新規エントリーのタイミングを提供

### 損益計算

- 取得単価を設定すると、現在の株価との比較で損益を計算し、具体的な指値価格を提案。

### AI分析出力内容

- 現在の損益状況（取得単価が設定されている場合）
- 売買判断とその理由（保有状況に応じて適切な用語を使用）
  - **通常保有銘柄（quantity > 0）の判断用語**：
    - 買い
    - 買い増し
    - 売り
    - ホールド
    - 様子見
  - **空売りポジション（quantity < 0）の判断用語**：
    - 買戻し（ポジション解消）
    - 追加売り（空売りポジション追加）
    - 維持（現在のポジション保持）
    - 様子見
- 推奨する指値価格（買い注文、売り注文、買戻し注文、または追加空売り注文）
- 保有状況を考慮した具体的な売買アクション（保有中銘柄については買い増しも含む、空売り中銘柄については買戻しや追加売りを含む）

## 口座種別による課税計算

### 口座種別

- 銘柄ごとに口座種別を設定可能（'特定'/'NISA'/'旧NISA'）。デフォルトは'特定'。

### 課税処理

- **特定口座**: 譲渡益に対して20.315%（所得税15.315% + 住民税5%）を課税
- **NISA口座**: 非課税（税額0円）
- **旧NISA口座**: 非課税（税額0円）

### AI分析レポートへの反映

- 現在の損益（税引前）
- 税額（特定口座で利益が出ている場合のみ）
- 税引後損益（利益・損失を考慮した実質的な損益）
- 口座種別の表示

### 損失時の扱い

- 損失が出ている場合は課税対象外のため、税額は表示されない。
- 投資判断の材料として、税金を考慮した実質的な損益を確認可能。
