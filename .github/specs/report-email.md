# レポート生成・メール配信機能仕様書

> **Note**: このファイルはレポート生成とメール配信機能の仕様を定義します。

## レポート生成機能

### HTML レポート生成

- 分析結果を HTML 形式で日次レポートとして自動生成。
- レポートは 1 銘柄ごとに HTML ファイルとして保存し、全銘柄分をまとめてメール本文にも埋め込む。
- 分析エラー発生時は、エラーメッセージをHTML形式でレポートに含める。

### レポート表示形式

- レポートの見出しには企業名を使用し、銘柄コードは副題として表示。
- HTMLタイトルには企業名と銘柄コードの両方を含める（例：「トヨタ自動車 (7203.T) 日次レポート」）。
- メール本文では、件名との重複を避け、銘柄名を主要な見出しとして使用。

### 折りたたみ機能

- 詳細レポートは折りたたみ可能で、デフォルトでは折りたたまれた状態で表示。
- ユーザーが必要に応じて詳細を展開できる。

### レポート簡略化機能

- ホールド判断時のレポート簡略化機能（環境変数 `SIMPLIFY_HOLD_REPORTS` で制御）。
- `true` (デフォルト): ホールド判断時は銘柄名、現在価格、ホールド理由の要約のみ表示
- `false`: ホールド判断でも詳細な分析レポートを表示

**環境変数の詳細は <a>README.md</a> を参照してください。**

## メール配信機能

### SMTP設定

- SMTP サーバ設定・送信元・宛先アドレス等は環境変数で管理。
- 複数宛先対応（カンマ・セミコロン区切り、またはリスト）。

### プライバシー保護

- すべての宛先は BCC で送信し、受信者間でアドレスが見えないよう配慮。
- To フィールドには送信元アドレスを設定。

### メール形式

- メール本文は HTML 形式。
- Markdown からHTMLへの変換機能を実装。

### 銘柄分類

銘柄を保有状況に基づいて分類し、読みやすく整理：

- **保有銘柄**: `quantity > 0` の銘柄
- **空売り銘柄**: `quantity < 0` の銘柄
- **購入検討中の銘柄**: `quantity` 未設定または `0` の銘柄

各分類はセクション見出しで区切られ、視覚的に識別しやすい。

### 目次機能

- メール本文には目次（Table of Contents）を自動生成。
- 売買判断を抽出してサマリーを作成し、一目で全体像を把握可能。

### メール件名

- 日付と分析対象銘柄数を含む件名を自動生成。
- 例：「株式レポート 2025-10-30 (5銘柄)」
