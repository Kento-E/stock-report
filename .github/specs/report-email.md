# レポート生成・メール配信機能仕様書

> **Note**: このファイルはレポート生成とメール配信機能の仕様を定義します。

## レポート生成機能

### HTML レポート生成

- 分析結果を HTML 形式で週2回（火曜日・木曜日）レポートとして自動生成。
- レポートは 1 銘柄ごとに HTML ファイルとして保存し、全銘柄分をまとめてメール本文にも埋め込む。
- 分析エラー発生時は、エラーメッセージをHTML形式でレポートに含める。

### レポート表示形式

- レポートの見出しには企業名を使用し、銘柄コードは副題として表示。
- HTMLタイトルには企業名と銘柄コードの両方を含める（例：「トヨタ自動車 (7203.T) レポート」）。
- メール本文では、件名との重複を避け、銘柄名を主要な見出しとして使用。

### 折りたたみ機能

- 詳細レポートは折りたたみ可能で、デフォルトでは折りたたまれた状態で表示。
- ユーザーが必要に応じて詳細を展開できる。

### レポート簡略化機能

- ホールド判断または維持判断時のレポート簡略化機能（環境変数 `SIMPLIFY_HOLD_REPORTS` で制御）。
- `true` (デフォルト):
  - ホールド判断時は銘柄名、現在価格、ホールド理由の要約のみ表示
  - 維持判断時は銘柄名、現在価格、維持理由の要約のみ表示
- `false`: ホールド判断・維持判断でも詳細な分析レポートを表示

**環境変数の詳細は <a>README.md</a> を参照してください。**

## メール配信機能

### SMTP設定

- SMTP サーバ設定・送信元・宛先アドレス等は環境変数で管理。
- 複数宛先対応（カンマ・セミコロン区切り、またはリスト）。

### プライバシー保護

- すべての宛先は BCC で送信し、受信者間でアドレスが見えないよう配慮。
- To フィールドには送信元アドレスを設定。

### メール形式

- メール本文は HTML 形式。
- Markdown からHTMLへの変換機能を実装。

### 銘柄分類

銘柄を保有状況に基づいて分類し、読みやすく整理：

- **保有銘柄**: `quantity > 0` の銘柄
- **空売り銘柄**: `quantity < 0` の銘柄
- **購入検討中の銘柄**: `quantity` 未設定または `0` の銘柄

各分類はセクション見出しで区切られ、視覚的に識別しやすい。

### 目次機能

- メール本文には目次（Table of Contents）を自動生成。
- 売買判断を抽出してサマリーを作成し、一目で全体像を把握可能。

#### 売買判断の視覚的な強調表示

目次の売買判断列では、アクションが必要な判断を視覚的に強調表示します：

- **売り判断・追加売り判断**: 赤字（#dc3545）+ 太字で表示し、損切りや空売り追加が必要な銘柄を目立たせる
- **買い判断・買い増し判断・買戻し判断**: 太字で表示し、購入機会や空売りポジションの解消機会を強調

その他の判断（ホールド、維持、様子見など）はデフォルトスタイル（装飾なし）で表示されます。

#### 売買判断の定義

**通常保有銘柄（quantity > 0）の判断用語**：

- **買い**: 新規に銘柄を購入する推奨
- **買い増し**: 既に保有している銘柄をさらに追加購入する推奨
- **売り**: 保有銘柄を売却する推奨（利益確定または損切り）
- **ホールド**: 既に保有している銘柄を継続保有する推奨（売却しない）
- **様子見**: 現時点では売買アクションを起こさず市場動向を観察する推奨

**空売りポジション（quantity < 0）の判断用語**：

- **買戻し**: 空売りポジションを解消する（買戻しによる利益確定または損切り）
- **追加売り**: 空売りポジションを追加する（現在の下落トレンドに乗る）
- **維持**: 現在の空売りポジションを継続保持する（買戻しも追加売りもしない）
- **様子見**: 現時点では売買アクションを起こさず市場動向を観察する推奨

**ホールド vs 維持の違い**:
- **ホールド**: 通常保有銘柄に対する判断。「売らずに持ち続ける」ことを推奨。
- **維持**: 空売りポジションに対する判断。「買戻しも追加売りもせず、ポジションを保持する」ことを推奨。

### メール件名

- 日付と分析対象銘柄数を含む件名を自動生成。
- 例：「株式レポート 2025-10-30 (5銘柄)」
