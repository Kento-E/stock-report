# GitHub Copilot Pull Request作成指示

Pull Requestを作成する際は、以下のルールを厳守してください。

## 言語設定

- **すべての出力は日本語で行うこと**
  - PRのタイトルは日本語で記述すること
  - PRのDescription（説明文）は日本語で記述すること
  - コメントを追加する場合も日本語で記述すること

## コミットハッシュの表記ルール

- **コミットハッシュは必ず前後に半角スペースを入れて素のまま記載すること（例: ...修正は 778aa44 で対応済み）**
  - Markdown リンクやインラインコード、引用、装飾は一切使わないこと
  - 7 文字以上の 16 進英数字のみを使い、コミットハッシュとして認識できる形式にすること
  - 例: ...修正は 778aa44 で対応済み
  - 誤: ...修正は[778aa44](https://github.com/...)で対応済み
  - 誤: ...修正は`778aa44`で対応済み
  - 誤: コミット`abc1234`で対応（前後にスペースがない）
  - GitHub は半角スペースで区切られたコミットハッシュを自動でリンク化するため、装飾は不要

### PRコメント・レビューコメントでの返信における注意事項

**`reply_to_comment` ツールを使用する際の重要なルール:**

- **コミットハッシュの前後には必ず半角スペースを入れること**
  - 正しい例: `コミット 778aa44 で修正しました。`
  - 誤った例: `コミット778aa44で修正しました。`（スペースなし）
  - 誤った例: `コミット`778aa44`で修正しました。`（インラインコード）
  - 誤った例: `コミット[778aa44](...)で修正しました。`（リンク）
- **文中でコミットハッシュを参照する場合の書き方**
  - テンプレート: `コミット {ハッシュ} で{対応内容}しました。`
  - 例: `コミット abc1234 で対応しました。`
  - 例: `修正は 778aa44 で完了しています。`
- **GitHub が自動リンク化するため、装飾は不要かつ禁止**
  - 半角スペースで区切られた7文字以上の16進数文字列は、GitHubが自動的にコミットリンクとして認識する
  - 手動でのリンク化やマークダウン装飾を行うと、自動リンク機能が無効化される

## PR 説明文の管理

- **PR 説明文を更新する際は、既存の HTML コメントを必ず保持すること**
  - 特に `<!-- for GitHub Copilot review rule -->` で囲まれた部分は絶対に削除しないこと
  - PR テンプレートの区切り線（`---`）以降の内容は常に保持すること
- **`report_progress` ツールを使用する際の注意**
  - PR テンプレートの HTML コメントを含めた完全な説明文を渡すこと
  - 説明文の最後に必ず以下の形式でテンプレートのコメントを含めること:

```markdown
## 変更内容

（あなたの説明文）

<!-- ここにPRの説明を記載してください -->
<!-- 以下の区切り線とコメントは削除・変更しないでください -->

---

<!-- for GitHub Copilot review rule -->
<!--
必ず、日本語でレビューしてください。レビュー結果を日本語で記載してください。
PRのタイトルを修正すべきであれば指摘してください。
-->
<!-- for GitHub Copilot review rule -->
```

## コーディング指示

このプロジェクトでコードを作成・編集する際は、以下のルールを厳守してください。

### エラーハンドリング

#### 必須チェック項目

- **リストや配列へのアクセス前に空チェックを実施**
  - `list[0]`のようなアクセスの前に、必ず`if not list:`または`if len(list) > 0:`でチェック
  - 例: `if similar_messages: first_message = similar_messages[0]`

- **`random.choice()`などの関数は空リストでエラーになるため事前チェック必須**
  - 空リストで`random.choice()`を呼ぶとIndexErrorが発生
  - 例: `if endings: ending = random.choice(endings) else: ending = "。"`

- **`dict.get()`でデフォルト値を指定し、Noneチェックを追加**
  - `dict.get(key, default_value)`を使用してNone回避
  - 取得後も値が空でないことを確認
  - 例: `greetings = persona.get('sample_greetings', []); if greetings: ...`

- **ファイル・ディレクトリ操作前に存在確認**
  - ディレクトリ作成: `os.makedirs(path, exist_ok=True)`
  - ファイル存在確認: `if os.path.exists(file_path):`

#### 正規表現の結果処理

- **`re.split()`の結果から空文字列を除外**
  - 例: `sentences = [s for s in re.split(r'[。！？]', text) if s.strip()]`
  - 空リスト対策: `response = sentences[0] if sentences else fallback_text`

### コード品質

#### リンター実行（必須）

**コード変更後は必ずリンターを実行してコミットすること**

コミット前に以下のいずれかの方法でリンターを実行し、すべてのエラーを修正してください：

##### Copilot向け特別指示

**Copilotがコードを生成する場合、`report_progress`でコミットする前に必ずリンターを実行して修正すること**

**基本方針: 変更したファイルのみをリンターで検証**

```bash
# 変更したファイルのみリンター実行（通常はこれで十分）
# 例: src/main.py を変更した場合
black src/main.py
isort --profile black src/main.py
autoflake --in-place --remove-all-unused-imports --remove-unused-variables src/main.py
flake8 src/main.py

# 複数ファイルを変更した場合
black src/file1.py src/file2.py
isort --profile black src/file1.py src/file2.py
autoflake --in-place --remove-all-unused-imports --remove-unused-variables src/file1.py src/file2.py
flake8 src/file1.py src/file2.py
```

**重要**: リンターエラーがある状態でコミットしないでください。CI/CDパイプラインで失敗します。

#### 基本ルール

- **未使用の変数・importは削除すること**
  - コミット前にリンター（flake8/pylint）を実行して確認
  - IDE/エディタの警告にも注意

- **変数名は明確に**
  - 目的が分かる名前を使用（例: `query_lower`は小文字変換されたクエリと分かる）
  - 略語は慣例的なもののみ使用

- **コメントは必要に応じて追加**
  - 複雑なロジックには説明コメントを追加
  - 自明なコードには不要
  - 既存のコメントスタイルに合わせる
  - **DRY原則に従う**: コメントにコードと同じ情報（変数名、定数値、モデル名など）を記載しない

- **削除された機能に関連するコードは完全に削除すること**
  - 参考資料、コメント、使用例なども含めてすべて削除
  - 過去の実装を参考として残さない
  - テストコード内の参考情報表示コードも同様に削除

### テストファイルの管理

#### コード変更時のテスト影響確認

コードやドキュメントを変更した際は、既存テストへの影響を必ず確認すること：

- **参照される文字列を変更した場合**
  - プロンプト設定、ドキュメント、エラーメッセージなど、他のファイルから参照される文字列を変更した際は、その文字列を使用している全テストファイルを確認すること
  - `grep -r "変更した文字列" tests/` で影響範囲を確認

- **コード変更後のテスト実行**
  - コード変更後は必ず関連するすべてのテストを実行し、影響を確認すること
  - 変更が完了したと思った時点で、もう一度全テストを実行して最終確認すること
  - テストが失敗した場合は、コード変更による意図的な仕様変更か、バグかを判断し、適切に対応すること

## チェックリスト

PR作成時は以下を確認：

- [ ] リスト・配列アクセス前に空チェックを実施したか
- [ ] `random.choice()`等の関数使用前にチェックしたか
- [ ] ファイル・ディレクトリ操作前に存在確認・作成したか
- [ ] 正規表現の結果処理で空文字列を考慮したか
- [ ] 未使用の変数・importを削除したか
- [ ] 変数名は明確か
- [ ] 必要なコメントを追加したか
- [ ] **（Copilot）コミット前にリンター（black, isort, autoflake, flake8）を実行したか**
- [ ] リンターでエラーがないか確認したか
- [ ] 削除した機能に関連するコード（参考資料含む）をすべて削除したか
- [ ] プロンプトやドキュメントなど参照される文字列を変更した場合、その文字列を使用している全テストファイルを確認したか
- [ ] コード変更後に関連するすべてのテストを実行し、影響を確認したか

## Markdownスタイル

- すべての見出し（#, ##, ### など）の直前・直後に必ず 1 行の空行を入れること
- 箇条書きやコードブロックの前後にも適切な空行を入れること
- markdownlint の警告が出ないよう、一般的な MarkdownLint ルールに従うこと
