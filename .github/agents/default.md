# GitHub Copilot デフォルト指示

このプロジェクトで作業する際は、以下のルールを厳守してください。

## はじめに

このリポジトリは、株式銘柄の動向をAIで自動分析し、レポートを生成・配信するPythonシステムです。

詳細な情報は以下のドキュメントを参照してください：

- **システム概要・技術スタック**: README.md
- **要件定義と仕様書**: specs/requirements-index.md（エントリーポイント）

## 言語設定

- **すべての出力は日本語で行うこと**
  - コミットメッセージは日本語で記述すること
  - PR のタイトルは日本語で記述すること
  - PR の Description（説明文）は日本語で記述すること
  - コード内のコメントを追加する場合も日本語で記述すること
  - Issueのタイトル・本文は日本語で記述すること

## コミットハッシュの表記ルール

- **コミットハッシュは必ず前後に半角スペースを入れて素のまま記載すること（例: ...修正は 778aa44 で対応済み）**
  - Markdown リンクやインラインコード、引用、装飾は一切使わないこと
  - 7 文字以上の 16 進英数字のみを使い、コミットハッシュとして認識できる形式にすること
  - GitHub は半角スペースで区切られたコミットハッシュを自動でリンク化するため、装飾は不要
  - Copilot や自動生成ツールもこのルールを厳守すること

### ✅ 正しい例

- ...修正は 778aa44 で対応済み
- コミット d4c99dd で対応しました
- 以下のコミットで修正：abc1234 および def5678

### ❌ 誤った例（リンク化されない）

- ...修正は `778aa44` で対応済み（バッククォートで囲んでいる）
- ...修正は[778aa44](https://github.com/...)で対応済み（手動リンク）
- コミット`abc1234`で対応（前後にスペースがない）

## Markdown スタイル

Markdown ファイルを生成・編集する際は、以下のルールを厳守してください。

### 見出しの前後に空行を入れる

- すべての見出し（#, ##, ### など）の直前・直後に必ず 1 行の空行を入れること。

### Lintルール

本プロジェクトで Markdown ファイル（README, 要件定義書, 質問リスト等）を生成・編集する際は、以下の Lint ルールに必ず準拠すること。

- 見出し階層は 1 段階ずつ（MD001）
- 見出し・リストの前後に必ず空行（MD022, MD032）
- h1 は 1 つのみ（MD025）
- ファイル末尾は 1 つの改行のみ（MD047）

### その他の推奨ルール

- 箇条書きやコードブロックの前後にも適切な空行を入れる
- markdownlint の警告が出ないよう、一般的な MarkdownLint ルールに従う
- Copilot が自動生成する際もこのルールを必ず守ること

## Python コーディング規約

### エラーハンドリングの必須チェック項目

- **リストや配列へのアクセス前に空チェックを実施**
  - `list[0]`のようなアクセスの前に、必ず`if not list:`または`if len(list) > 0:`でチェック
  - 例: `if similar_messages: first_message = similar_messages[0]`

- **`random.choice()`などの関数は空リストでエラーになるため事前チェック必須**
  - 空リストで`random.choice()`を呼ぶとIndexErrorが発生
  - 例: `ending = random.choice(endings) if endings else "。"`

- **`dict.get()`でデフォルト値を指定し、Noneチェックを追加**
  - `dict.get(key, default_value)`を使用してNone回避
  - 取得後も値が空でないことを確認
  - 例: `greetings = persona.get('sample_greetings', []); if greetings: ...`

- **ファイル・ディレクトリ操作前に存在確認**
  - ディレクトリ作成: `os.makedirs(path, exist_ok=True)`
  - ファイル存在確認: `if os.path.exists(file_path):`

### 正規表現の結果処理

- **`re.split()`の結果から空文字列を除外**
  - 例: `sentences = [s for s in re.split(r'[。！？]', text) if s.strip()]`
  - 空リスト対策: `response = sentences[0] if sentences else fallback_text`

### コード品質の基本ルール

- **未使用の変数・importは削除すること**
  - コミット前にリンター（flake8/pylint）を実行して確認
  - IDE/エディタの警告にも注意

- **変数名は明確に**
  - 目的が分かる名前を使用（例: `query_lower`は小文字変換されたクエリと分かる）
  - 略語は慣例的なもののみ使用

- **コメントは必要に応じて追加**
  - 複雑なロジックには説明コメントを追加（日本語推奨）
  - 自明なコードには不要
  - 既存のコメントスタイルに合わせる

### 推奨ツール（リンター・フォーマッター）

- **flake8**: Pythonコードの静的解析
- **pylint**: より詳細なコード品質チェック
- **autoflake**: 未使用importの自動削除
- **isort**: import文の自動整形
- **black**: コードの自動フォーマット

### コミット前のlint実行（重要）

**ファイルを変更した場合、コミット前に必ず該当ファイルに対してlintを実行してください**。これにより、CI失敗を事前に防ぐことができます。

`.pre-commit-config.yaml`に定義されているlintツールを、変更したファイルに対して実行してください：

- **Markdownファイル**: `markdownlint --config=.markdownlint.json <変更したファイル>`
- **Pythonファイル**: `black <変更したファイル>` → `isort <変更したファイル>` → `flake8 <変更したファイル>`

例：
```bash
# Markdownファイルを編集した場合
markdownlint --config=.markdownlint.json README.md docs/TEST.md

# Pythonファイルを編集した場合
black src/main.py
isort src/main.py
flake8 src/main.py
```

**注意**: リポジトリ全体ではなく、変更したファイルのみを対象にlintを実行してください。

## ドキュメント・要件定義書の反映

### 基本原則

- ソースコードを修正した場合は、該当する仕様書にも必ず要件を反映してください。
- 要件定義書は機能別に分割されています。該当する仕様書を更新してください。
- DRY原則（Don't Repeat Yourself）を守り、情報の重複を避けてください。

### 仕様書の選択

変更内容に応じて、適切な仕様書を更新してください：

- **システム構成・モジュール変更**: specs/system-architecture.md
- **データ収集・AI分析機能**: specs/data-collection-analysis.md
- **レポート生成・メール配信**: specs/report-email.md
- **自動化・テスト・CI/CD**: specs/automation-cicd.md
- **銘柄リスト・投資志向性設定**: specs/data-management.md

### ドキュメントの責任分掌

各ドキュメントには明確な役割があります。内容を適切なファイルに配置してください：

#### README.md

- **目的**: ユーザー向けクイックスタートガイド
- **内容**:
  - プロジェクトの概要
  - 必要な環境設定の概要
  - 基本的な実行手順
  - 高レベルの機能説明
- **避けるべき内容**: 詳細な技術仕様、詳細なトラブルシューティング、内部アーキテクチャ

#### .github/specs/*.md（要件定義書）

- **目的**: システムの恒久的な仕様を記載
- **内容**:
  - システムの機能要件（データ収集、AI分析、レポート生成など）
  - 非機能要件（セキュリティ、パフォーマンス、拡張性など）
  - システム構成とモジュール設計
  - 利用技術とアーキテクチャ
  - 運用・保守方針
- **避けるべき内容**:
  - 特定のバグや警告の解決方法
  - トラブルシューティング手順
  - 特定の問題に対する暫定的な対応
  - 環境構築時の一時的な問題と解決策
  - 変更履歴（Gitで管理）
  - リリースノート的な内容（「〇〇を変更して△△%削減」など、変更の効果や理由の説明）

#### docs/*.md（専門ドキュメント）

- **目的**: 特定の機能やシステムの詳細な説明
- **内容**:
  - 詳細なアーキテクチャ
  - フローダイアグラム
  - 技術的な詳細説明
  - 詳細なトラブルシューティング
  - セキュリティ考慮事項
  - ベストプラクティス
- **例**:
  - `docs/TEST.md`: ユニットテストの実行方法

### DRY原則（Don't Repeat Yourself）

情報の重複を避け、単一情報源（Single Source of Truth）を維持してください：

1. **詳細な技術説明**: 1つの専門ドキュメントに記載し、他のドキュメントからは参照リンクで誘導
2. **設定値**: コード（設定ファイルなど）を情報源とし、ドキュメントからは参照リンクを使用
3. **手順**: 1箇所に詳細を記載し、他の場所では要約+参照リンクを使用

## GitHub Copilot Premium の効率的な利用

GitHub Copilot Premium の消費を節約しつつ、コード品質を維持するため、以下の方針に従ってください。

### テスト戦略

テスト自動化の詳細については `docs/TEST.md` を参照してください。

重要なポイント：

- Pull Request作成時に自動的にテストが実行されるため、手動でのテスト実施は不要
- 新規機能追加時は、既存のテストパターンに従って必要最小限のテストを追加
- ローカルでのテスト実行は、デバッグ時など必要な場合のみ実施

### ドキュメント方針

- **仕様書の更新は必須**: システムの機能や構成に変更があった場合、該当する仕様書への反映は必須です。
- **実用性の確認**: 新規ドキュメントの作成は、明確な実用性がある場合のみ行ってください。
- **既存ドキュメントの活用**: 既存ドキュメントを優先的に更新してください。新規ファイルの作成は最小限に。
- **サンプルやテンプレートファイル**: 実際に使用されないサンプルファイルやテンプレートファイルの作成は避けてください。

### 作業効率化

- **最小限の変更**: 問題を解決するために必要最小限のコード変更を心がけてください。
- **自動化の活用**: テスト、ビルド、デプロイなどは既存のGitHub Actionsワークフローを活用してください。
- **重複作業の回避**: 同じような処理が既に実装されている場合、既存のコードを再利用してください。

## VS Code カスタムチャット参加者

VS Code で GitHub Copilot を使用する際、カスタムチャット参加者を利用できます。

- **@kansai**: 関西弁で応答するフレンドリーなプログラミングアシスタント

詳細は `copilot-chat-participants.md` を参照してください。

## 参考リンク

- README.md: ユーザー向け使用方法・セットアップ手順
- data/README.md: 銘柄リスト・投資志向性設定の編集ガイド
- docs/TEST.md: ユニットテストの実行方法
- specs/requirements-index.md: 要件定義と機能別仕様書のインデックス
