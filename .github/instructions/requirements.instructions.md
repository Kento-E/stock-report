# 要件定義書

> **Note**: このファイルは開発者およびGitHub Copilot向けの技術仕様書です。  
> ユーザー向けの使用方法・セットアップ手順は [README.md](../../README.md) を参照してください。

## 1. システム概要

銘柄株の動向やトレンドを Claude Sonnet（AI）で日次に調査・分析し、HTML レポートとして自動生成・メール配信するシステム。

## 2. 目的

- 投資判断の材料となる情報を自動で収集・分析し、分かりやすいレポートとして提供する。
- 日々の株式市場の変化を迅速に把握できるようにする。

## 3. 機能要件

### 3.1 データ収集

- 対象銘柄リストはリポジトリ内の `data/stocks.yaml` ファイル（YAML形式）で管理。
- 上場予定銘柄リストは `data/ipo_stocks.yaml` ファイル（YAML形式）で管理。
- デフォルト値: '7203.T,6758.T'（ファイルが存在しない場合）
- 日本株（.T、.JP サフィックス）と米国株の両方に対応。
- 株価データを Yahoo Finance API（RapidAPI 経由）から日次で自動取得する。
- ニュースデータは defeatbeta-api を使用して実際のニュースを取得（最大5件）。
- 銘柄リストはYAML形式で管理し、銘柄コード、企業名、追加日、メモなどを構造化して記録可能。
- 上場予定銘柄（IPO）は処理実行日から7日以内に上場予定の銘柄を対象とする。

### 3.2 AI 分析

- Claude Sonnet API（最新モデル: claude-3-sonnet-latest など）または Gemini API を用いて、収集データの動向・トレンド・リスク/チャンスを日本語で要約・分析する。
- API キー・モデル名は環境変数で管理。
- 銘柄ごとに適切な通貨で分析を実施：
  - `currency`フィールドで明示的に指定された通貨を使用
  - 未指定の場合は銘柄シンボルから自動判定（日本株→円、その他→ドル）
  - 円、ドル、ユーロ、ポンドなど、任意の通貨に対応
- エラー発生時は、詳細なエラーメッセージ（例外内容、HTTPステータスコード、API応答など）をマークダウン形式で返し、メール本文に含める。

### 3.3 レポート生成

- 分析結果を HTML 形式で日次レポートとして自動生成。
- レポートは 1 銘柄ごとに HTML ファイルとして保存し、全銘柄分をまとめてメール本文にも埋め込む。
- 上場予定銘柄（IPO）は別途レポートを生成し、専用のメールで配信する。
- 分析エラー発生時は、エラーメッセージをHTML形式でレポートに含める。
- レポートの見出しには企業名を使用し、銘柄コードは副題として表示。企業名が設定されていない場合は銘柄コードを見出しに使用。
- HTMLタイトルには企業名と銘柄コードの両方を含める（例：「トヨタ自動車 (7203.T) 日次レポート」）。
- IPO銘柄のレポートタイトルには「上場予定銘柄レポート」を使用する。

### 3.4 メール配信

- SMTP サーバ設定・送信元・宛先アドレス等は環境変数で管理。
- 複数宛先対応（カンマ・セミコロン区切り、またはリスト）。
- すべての宛先は BCC で送信し、受信者間でアドレスが見えないよう配慮。
- メール本文は HTML 形式。
- 銘柄を保有状況に基づいて分類し、読みやすく整理：
  - **保有銘柄**: `quantity > 0` の銘柄
  - **空売り銘柄**: `quantity < 0` の銘柄
  - **購入検討中の銘柄**: `quantity` 未設定または `0` の銘柄
- 各分類はセクション見出し（H2）で区切られ、視覚的に識別しやすい。
- 上場予定銘柄（IPO）は別途専用のメールで配信され、件名は「上場予定銘柄レポート」となる。

### 3.5 スケジューラ・自動化

- GitHub Actions 等の CI/CD で日次自動実行が可能。
- .env や Secrets で安全に API キー・認証情報を管理。
- 対象銘柄リストはリポジトリ内の `data/stocks.yaml` ファイル（YAML形式）で管理し、Git で変更履歴を追跡。

### 3.6 自動マージ機能

- GitHub Copilot が作成した Pull Request を承認（Approve）すると、自動的にマージされる。
- マージ方式はスカッシュマージ（Squash Merge）を採用し、コミット履歴を整理。
- マージ後、自動的にブランチを削除してリポジトリを整理。
- GitHub Actions の `pull_request_review` イベントをトリガーとして実行。

### 3.7 カスタムチャットモード

- VS Code の GitHub Copilot で使用可能なカスタムチャット参加者（Custom Chat Participant）を定義。
- `.github/copilot-instructions.md` ファイルでカスタムチャットモードを設定。
- `@kansai` とメンションすることで、関西弁で応答するフレンドリーなプログラミングアシスタントを利用可能。
- コードの質問や相談に対して、関西弁でわかりやすく親しみやすい回答を提供。
- 技術的な正確性を保ちつつ、「せやな」「ほんまに」「ええで」などの関西弁特有の表現を使用。

### 3.8 テスト自動化

- pytest を使用したユニットテストの実装により、コードの品質を保証。
- Pull Request 作成時・プッシュ時に GitHub Actions で自動的にテストを実行。
- テストカバレッジレポートの生成とアーティファクト保存。
- テスト対象モジュール：
  - stock_loader（銘柄リスト読み込み、多通貨対応の通貨判定、銘柄分類、口座種別管理、課税計算）
  - ipo_loader（上場予定銘柄リスト読み込み、日付フィルタリング）
  - data_fetcher（データ構造検証）
  - report_generator（HTMLレポート生成、IPO銘柄レポート生成）
  - mail_utils（メール本文生成、分類別メール本文生成、マークダウン変換）
  - ai_analyzer（保有状況プロンプト生成、多通貨対応の損益計算、口座種別を考慮した税引後損益計算）
- CI/CD パイプラインでテストが失敗した場合、マージをブロック。
- GitHub Copilot Premium の消費を節約しつつ、コード品質を維持。

### 3.9 GitHub Copilot Premium の効率的な利用

- GitHub Copilot への明確な指示により、不要な処理を抑制し、Premium消費を節約。
- テスト自動化（pytest + GitHub Actions）の活用により、手動テスト実施を最小化。
- 既存ドキュメントの優先的な更新により、実用性の低いドキュメントファイルの作成を回避。
- 要件定義書の更新は必須としつつ、その他のドキュメント作成は実用性が明確な場合のみ実施。
- 最小限の変更と既存コードの再利用により、作業効率を最大化。
- 自動化ワークフロー（テスト、ビルド、デプロイ、自動マージ）の活用により、手動作業を削減。

## 4. 非機能要件

- セキュリティ：API キーや個人情報の安全な管理（.env, Secrets, BCC 運用等）。
- パフォーマンス：日次処理が 1 時間以内に完了すること。
- 拡張性：銘柄追加や分析ロジックの拡張が容易。銘柄リストはYAML形式で管理し、スマートフォンからも編集可能。銘柄ごとに追加メタデータを柔軟に管理可能。
- 保守性：設定や運用が容易で、モジュール分割・関数化されていること。銘柄の変更履歴を Git で管理。
- 多市場・多通貨対応：日本株（円）、米国株（ドル）、欧州株（ユーロ）など、複数の市場と通貨に対応可能な設計。

## 5. システム構成

### 5.1 モジュール構成

システムはAPI別・機能別にモジュール化されており、単一責任の原則に従って設計されています。

#### コアモジュール（src/）

- **main.py**：メインエントリーポイント。各モジュールを組み合わせたオーケストレーション処理。全体のワークフローを制御し、データ取得・分析・レポート生成・メール配信の一連の処理を統合する。
- **config.py**：環境変数の読み込みと設定値の一元管理。API キー、メール設定、モデル名などのシステム設定を管理する。
- **stock_loader.py**：YAML銘柄リストの読み込み、通貨判定、銘柄分類機能。銘柄データの読み込みと保有状況に基づく分類（保有中、空売り中、購入検討中）を担当する。
- **ipo_loader.py**：YAML上場予定銘柄リストの読み込みとフィルタリング機能。上場予定日が近い銘柄（デフォルト7日以内）を抽出する。
- **data_fetcher.py**：Yahoo Finance APIとdefeatbeta-apiによるデータ取得。株価データとニュースデータの取得を担当し、外部APIとの通信を抽象化する。
- **ai_analyzer.py**：Claude API/Gemini APIによる分析処理と保有状況プロンプト生成。取得したデータを基にAIで分析を実施し、売買判断と推奨価格を含むレポートを生成する。IPO銘柄用の専用プロンプトにも対応。
- **report_generator.py**：HTMLレポート生成とファイル保存。分析結果をHTML形式に変換し、ファイルとして保存する。IPO銘柄用のレポートにも対応。
- **mail_utils.py**：メール送信・SMTP 設定・分類別メール本文生成のユーティリティ。メール配信機能を提供し、保有状況に応じて分類されたメール本文を生成する。

#### データ・設定ファイル

- **data/stocks.yaml**：分析対象銘柄リスト（YAML形式、Git で変更履歴管理）
- **data/ipo_stocks.yaml**：上場予定銘柄リスト（YAML形式、Git で変更履歴管理）
- **requirements.txt**：依存パッケージ管理
- **.env/.env.example**：環境変数テンプレート

#### GitHub Actions・設定

- **.github/workflows/report.yml**：自動実行ワークフロー
- **.github/workflows/auto-merge.yml**：PR 承認時の自動マージワークフロー
- **.github/workflows/test.yml**：テスト自動実行ワークフロー
- **.github/copilot-instructions.md**：VS Code 用カスタムチャットモード定義

#### テスト（tests/）

テストの詳細については [docs/TEST.md](../../docs/TEST.md) を参照してください。

### 5.2 モジュール間の関係

```
main.py (オーケストレーション)
  ├── config.py (設定管理)
  ├── stock_loader.py (銘柄データ読み込み)
  ├── ipo_loader.py (上場予定銘柄データ読み込み)
  ├── data_fetcher.py (外部API: Yahoo Finance, defeatbeta-api)
  │     └── config.py
  ├── ai_analyzer.py (AI分析: Claude, Gemini)
  │     ├── config.py
  │     └── stock_loader.py
  ├── report_generator.py (レポート生成)
  │     └── mail_utils.py
  └── mail_utils.py (メール配信)
```

## 6. 利用技術

- Python（データ収集・分析・レポート生成・メール送信）
- anthropic（Claude Sonnet API 公式パッケージ）
- defeatbeta-api（市場ニュースデータ取得）
- PyYAML（YAML ファイルの解析）
- requests, python-dotenv, smtplib, email, markdown
- pytest, pytest-cov（テストフレームワーク・カバレッジ測定）
- GitHub Actions（スケジューラ・自動化・CI/CD）

## 7. 運用・保守

- エラー通知・ログ出力（print ベース、今後拡張可）
- エラー詳細情報をメール本文に含めることで、GitHub Actions画面を確認せずに原因把握が可能
- API キー・認証情報の安全な管理
- モデル EOL や API 仕様変更時の迅速な対応
- モジュール分割により、各機能の独立したテスト・保守が可能
- 自動テストによりコード品質を継続的に保証
- Pull Request 作成時の自動テスト実行により、問題を早期発見

## 8. その他

- 法令遵守（金融商品取引法等）
- 利用規約・プライバシーポリシーの整備

## 9. 実行環境

- GitHub Actions 上で定期実行（cron スケジューラ）を行う。
- 実行時刻は JST（日本標準時）で平日（月曜日～金曜日）の午前 9 時 10 分。
- 土日は株式市場が休みのため実行しない。
- Claude Sonnet API キーやメール配信設定等の機密情報は、GitHub リポジトリの「Secrets」で安全に管理する。
- 対象銘柄リストは `data/stocks.yaml` ファイル（YAML形式）で管理し、Git で変更履歴を追跡する。
- レポート生成・配信処理も Actions workflow で自動化する。

**環境変数の詳細はREADME.mdを参照してください。**

## 10. 銘柄リスト管理

- 銘柄リストは `data/stocks.yaml` ファイル（YAML形式）で管理。
- 構造化されたデータ形式で、銘柄ごとに以下の情報を管理可能：
  - `symbol`（必須）: 銘柄コード
  - `name`（任意）: 企業名。レポートの見出しに使用される。未設定の場合は銘柄コードが使用される。
  - `added`（任意）: 追加日
  - `note`（任意）: メモ・注記
  - `quantity`（任意）: 保有数（プラスは保有、マイナスは空売り、未設定は購入検討中）
  - `acquisition_price`（任意）: 取得単価（購入価格または空売り価格）
  - `currency`（任意）: 通貨単位（円、ドル、ユーロ、ポンドなど）。未設定の場合は銘柄シンボルから自動判定
  - `account_type`（任意）: 口座種別（'特定'/'NISA'/'旧NISA'、デフォルトは'特定'）
    - **特定**: 譲渡益に20.315%課税
    - **NISA**: 非課税
    - **旧NISA**: 非課税
- YAMLのコメント機能（`#` で始まる行）を使用可能。
- Git で変更履歴を管理できるため、いつ・誰が・どの銘柄を追加/削除したか追跡可能。
- スマートフォンのブラウザからも GitHub の Web インターフェースで簡単に編集可能。
- 将来的に銘柄ごとの追加設定（アラート閾値、分析頻度など）を柔軟に追加可能。

**銘柄リストの編集方法の詳細はREADME.mdを参照してください。**

## 11. 売買タイミング分析機能

- 銘柄の保有状況（保有数、取得単価）を設定することで、AI が保有状況を考慮した売買判断を提供。
- 保有数の解釈：
  - 正の数（例: 100）: 保有中の銘柄として、売却タイミングや追加購入の判断を提供
  - 負の数（例: -50）: 空売り中（信用売り）として、買戻しタイミングの判断を提供
  - 未設定: 購入または空売りを検討中として、新規エントリーのタイミングを提供
- 取得単価を設定すると、現在の株価との比較で損益を計算し、具体的な指値価格を提案。
- AI 分析には以下の情報が含まれる：
  - 現在の損益状況（取得単価が設定されている場合）
  - 売買判断（買い/売り/ホールド/様子見）とその理由
  - 推奨する指値価格（買い注文または売り注文）
  - 保有状況を考慮した具体的な売買アクション

## 12. 口座種別による課税計算機能

- 銘柄ごとに口座種別を設定可能（'特定'/'NISA'/'旧NISA'）。デフォルトは'特定'。
- 口座種別に応じた課税処理：
  - **特定口座**: 譲渡益に対して20.315%（所得税15.315% + 住民税5%）を課税
  - **NISA口座**: 非課税（税額0円）
  - **旧NISA口座**: 非課税（税額0円）
- AI分析レポートには以下の情報が含まれる：
  - 現在の損益（税引前）
  - 税額（特定口座で利益が出ている場合のみ）
  - 税引後損益（利益・損失を考慮した実質的な損益）
  - 口座種別の表示
- 損失が出ている場合は課税対象外のため、税額は表示されない。
- 投資判断の材料として、税金を考慮した実質的な損益を確認可能。

## 13. 上場予定銘柄（IPO）レポート機能

- 上場予定銘柄を `data/ipo_stocks.yaml` ファイル（YAML形式）で管理。
- 構造化されたデータ形式で、銘柄ごとに以下の情報を管理可能：
  - `symbol`（必須）: 銘柄コード（仮コードでも可）
  - `name`（必須）: 企業名
  - `ipo_date`（任意）: 上場予定日（YYYY-MM-DD形式）
  - `market`（任意）: 上場市場（例: 東証プライム、東証スタンダード、NASDAQ等）
  - `expected_price`（任意）: 想定価格・公募価格
  - `currency`（任意）: 通貨単位（円、ドル、ユーロ等。未設定の場合は自動判定）
  - `note`（任意）: メモ・注記
- 処理実行日から7日以内に上場予定の銘柄を自動的に抽出してレポート生成。
- 上場予定日が設定されていない銘柄も含まれる。
- AI分析では以下の観点で評価：
  - 企業概要と事業内容
  - IPO銘柄としての魅力と期待値
  - 上場後の株価動向の予測
  - 投資判断（購入検討/様子見/見送り）
  - 公募価格の妥当性（設定されている場合）
  - リスク要因と注意点
- IPO銘柄のレポートは既存の通常レポートとは別に生成され、専用のメールで配信される。
- メール件名は「上場予定銘柄レポート」となる。
- YAMLファイルが存在しない、または銘柄が登録されていない場合は、IPOレポート処理をスキップし、エラーにならない。

**上場予定銘柄リストの編集方法の詳細はREADME.mdを参照してください。**

---

（本要件定義書は現行のモジュール化されたシステム設計・実装内容に基づき、今後の議論・運用により随時更新します）
