# 要件定義書

## 1. システム概要

銘柄株の動向やトレンドを Claude Sonnet（AI）で日次に調査・分析し、HTML レポートとして自動生成・メール配信するシステム。

## 2. 目的

- 投資判断の材料となる情報を自動で収集・分析し、分かりやすいレポートとして提供する。
- 日々の株式市場の変化を迅速に把握できるようにする。

## 3. 機能要件

### 3.1 データ収集

- 対象銘柄リストは環境変数 `STOCK_SYMBOLS` で設定可能（カンマ区切り）。
- デフォルト値: '7203.T,6758.T'（未設定時）
- 日本株（.T、.JP サフィックス）と米国株の両方に対応。
- 株価データを Yahoo Finance API（RapidAPI 経由）から日次で自動取得する。
- ニュースデータも将来的に拡張可能な構造で取得（現状はダミー実装）。

### 3.2 AI 分析

- Claude Sonnet API（最新モデル: claude-3-sonnet-latest など）または Gemini API を用いて、収集データの動向・トレンド・リスク/チャンスを日本語で要約・分析する。
- API キー・モデル名は環境変数で管理。
- 銘柄シンボルから市場を自動判定し、適切な通貨（円/ドル）で分析を実施。
  - 日本株（.T、.JP サフィックス）→「円」
  - 米国株など → 「ドル」
- エラー発生時は、詳細なエラーメッセージ（例外内容、HTTPステータスコード、API応答など）をマークダウン形式で返し、メール本文に含める。

### 3.3 レポート生成

- 分析結果を HTML 形式で日次レポートとして自動生成。
- レポートは 1 銘柄ごとに HTML ファイルとして保存し、全銘柄分をまとめてメール本文にも埋め込む。
- 分析エラー発生時は、エラーメッセージをHTML形式でレポートに含める。

### 3.4 メール配信

- SMTP サーバ設定・送信元・宛先アドレス等は環境変数で管理。
- 複数宛先対応（カンマ・セミコロン区切り、またはリスト）。
- すべての宛先は BCC で送信し、受信者間でアドレスが見えないよう配慮。
- メール本文は HTML 形式。

### 3.5 スケジューラ・自動化

- GitHub Actions 等の CI/CD で日次自動実行が可能。
- .env や Secrets で安全に API キー・認証情報を管理。
- 対象銘柄リスト（STOCK_SYMBOLS）は GitHub Actions の Variables で管理（機密情報ではないため）。

### 3.6 自動マージ機能

- GitHub Copilot が作成した Pull Request を承認（Approve）すると、自動的にマージされる。
- マージ方式はスカッシュマージ（Squash Merge）を採用し、コミット履歴を整理。
- マージ後、自動的にブランチを削除してリポジトリを整理。
- GitHub Actions の `pull_request_review` イベントをトリガーとして実行。

## 4. 非機能要件

- セキュリティ：API キーや個人情報の安全な管理（.env, Secrets, BCC 運用等）。
- パフォーマンス：日次処理が 1 時間以内に完了すること。
- 拡張性：銘柄追加や分析ロジック、ニュース API 拡張が容易。環境変数による柔軟な設定変更。
- 保守性：設定や運用が容易で、モジュール分割・関数化されていること。
- 多市場対応：日本株と米国株など、複数の市場に対応可能な設計。

## 5. システム構成

- main.py：データ収集・AI 分析・レポート生成・配信の統括
- mail_utils.py：メール送信・SMTP 設定・本文生成のユーティリティ
- requirements.txt：依存パッケージ管理
- .env/.env.example：環境変数テンプレート
- .github/workflows/report.yml：自動実行ワークフロー
- .github/workflows/auto-merge.yml：PR 承認時の自動マージワークフロー

## 6. 利用技術

- Python（データ収集・分析・レポート生成・メール送信）
- anthropic（Claude Sonnet API 公式パッケージ）
- requests, python-dotenv, smtplib, email
- GitHub Actions（スケジューラ・自動化）

## 7. 運用・保守

- エラー通知・ログ出力（print ベース、今後拡張可）
- エラー詳細情報をメール本文に含めることで、GitHub Actions画面を確認せずに原因把握が可能
- API キー・認証情報の安全な管理
- モデル EOL や API 仕様変更時の迅速な対応

## 8. その他

- 法令遵守（金融商品取引法等）
- 利用規約・プライバシーポリシーの整備

## 9. 実行環境

- GitHub Actions 上で定期実行（cron スケジューラ）を行う。
- 実行時刻は JST（日本標準時）で平日（月曜日～金曜日）の午前 9 時 10 分。
- 土日は株式市場が休みのため実行しない。
- Claude Sonnet API キーやメール配信設定等の機密情報は、GitHub リポジトリの「Secrets」で安全に管理する。
- 対象銘柄リスト（STOCK_SYMBOLS）は「Variables」で管理する（機密情報ではないため）。
- レポート生成・配信処理も Actions workflow で自動化する。

## 10. 環境変数

| 変数名           | 種類     | 用途                                   | デフォルト値      |
| ---------------- | -------- | -------------------------------------- | ----------------- |
| `CLAUDE_API_KEY` | Secret   | Claude Sonnet API キー                 | なし（必須）      |
| `GEMINI_API_KEY` | Secret   | Gemini API キー                        | なし（必須）      |
| `YAHOO_API_KEY`  | Secret   | Yahoo Finance API キー                 | なし（必須）      |
| `MAIL_TO`        | Secret   | レポート送信先メールアドレス           | なし（必須）      |
| `MAIL_FROM`      | Secret   | 送信元メールアドレス                   | なし（必須）      |
| `SMTP_SERVER`    | Secret   | SMTP サーバー                          | なし（必須）      |
| `SMTP_PORT`      | Secret   | SMTP ポート                            | なし（必須）      |
| `SMTP_USER`      | Secret   | SMTP 認証ユーザー                      | なし（必須）      |
| `SMTP_PASS`      | Secret   | SMTP 認証パスワード                    | なし（必須）      |
| `STOCK_SYMBOLS`  | Variable | 分析対象銘柄リスト（カンマ区切り）     | 7203.T,6758.T     |

---

（本要件定義書は現行の main.py・mail_utils.py の設計・実装内容に基づき、今後の議論・運用により随時更新します）
