# 要件定義書

> **Note**: このファイルは開発者およびGitHub Copilot向けの技術仕様書です。  
> ユーザー向けの使用方法・セットアップ手順は <a>README.md</a> を参照してください。

## 1. システム概要

銘柄株の動向やトレンドを Claude Sonnet（AI）で日次に調査・分析し、HTML レポートとして自動生成・メール配信するシステム。

## 2. 目的

- 投資判断の材料となる情報を自動で収集・分析し、分かりやすいレポートとして提供する。
- 日々の株式市場の変化を迅速に把握できるようにする。

## 3. 機能要件

### 3.1 データ収集

- 対象銘柄リストはリポジトリ内の `data/stocks.yaml` ファイル（YAML形式）で管理。
- デフォルト値: '7203.T,6758.T'（ファイルが存在しない場合）
- 日本株（.T、.JP サフィックス）と米国株の両方に対応。
- 銘柄コードの柔軟な入力：
  - 文字列形式（例：'7203.T'）と数値形式（例：7203）の両方をサポート
  - 4桁の数値は自動的に日本株として認識され、`.T`サフィックスが追加される
  - 通貨が未設定の場合、4桁数値は自動的に「円」と判定される
- 株価データを Yahoo Finance API（RapidAPI 経由）から日次で自動取得する。
- ニュースデータは defeatbeta-api を使用して実際のニュースを取得（最大5件）。
- 銘柄リストはYAML形式で管理し、銘柄コード、企業名、追加日、メモなどを構造化して記録可能。

### 3.2 AI 分析

- Claude Sonnet API（最新モデル: claude-3-sonnet-latest など）または Gemini API を用いて、収集データの動向・トレンド・リスク/チャンスを日本語で要約・分析する。
- API キー・モデル名は環境変数で管理。
- 銘柄ごとに適切な通貨で分析を実施：
  - `currency`フィールドで明示的に指定された通貨を使用
  - 未指定の場合は銘柄シンボルから自動判定（日本株→円、その他→ドル）
  - 円、ドル、ユーロ、ポンドなど、任意の通貨に対応
- エラー発生時は、詳細なエラーメッセージ（例外内容、HTTPステータスコード、API応答など）をマークダウン形式で返し、メール本文に含める。
- **投資志向性の反映**：ユーザーの投資スタイル、リスク許容度、投資期間などの志向性をAI分析のプロンプトに含め、個人の投資方針に合わせた分析を提供：
  - 投資スタイル：成長投資、バリュー投資、インカムゲイン投資、バランス投資、投機的投資から選択
  - リスク許容度：低・中・高の3段階
  - 投資期間：短期・中期・長期
  - 売買頻度の傾向：頻繁・適度・少ない
  - 重視する指標：テクニカル分析、ファンダメンタル分析、ニュース、配当、モメンタムから複数選択可能
  - カスタムメッセージ：追加の要望を自由記述

### 3.3 レポート生成

- 分析結果を HTML 形式で日次レポートとして自動生成。
- レポートは 1 銘柄ごとに HTML ファイルとして保存し、全銘柄分をまとめてメール本文にも埋め込む。
- 分析エラー発生時は、エラーメッセージをHTML形式でレポートに含める。
- レポートの見出しには企業名を使用し、銘柄コードは副題として表示。
- HTMLタイトルには企業名と銘柄コードの両方を含める（例：「トヨタ自動車 (7203.T) 日次レポート」）。
- メール本文では、件名との重複を避け、銘柄名を主要な見出しとして使用。
- 詳細レポートは折りたたみ可能で、デフォルトでは折りたたまれた状態で表示。
- ホールド判断時のレポート簡略化機能（環境変数 `SIMPLIFY_HOLD_REPORTS` で制御）。

### 3.4 メール配信

- SMTP サーバ設定・送信元・宛先アドレス等は環境変数で管理。
- 複数宛先対応（カンマ・セミコロン区切り、またはリスト）。
- すべての宛先は BCC で送信し、受信者間でアドレスが見えないよう配慮。
- メール本文は HTML 形式。
- 銘柄を保有状況に基づいて分類し、読みやすく整理：
  - **保有銘柄**: `quantity > 0` の銘柄
  - **空売り銘柄**: `quantity < 0` の銘柄
  - **購入検討中の銘柄**: `quantity` 未設定または `0` の銘柄
- 各分類はセクション見出しで区切られ、視覚的に識別しやすい。

### 3.5 スケジューラ・自動化

- GitHub Actions 等の CI/CD で日次自動実行が可能。
- .env や Secrets で安全に API キー・認証情報を管理。
- 対象銘柄リストはリポジトリ内の `data/stocks.yaml` ファイル（YAML形式）で管理し、Git で変更履歴を追跡。

### 3.6 自動マージ機能

- GitHub Copilot が作成した Pull Request を承認（Approve）すると、自動的にマージされる。
- マージ方式はスカッシュマージ（Squash Merge）を採用し、コミット履歴を整理。
- マージ後、自動的にブランチを削除してリポジトリを整理。
- GitHub Actions の `pull_request_review` イベントをトリガーとして実行。

### 3.7 カスタムチャットモード

- VS Code の GitHub Copilot で使用可能なカスタムチャット参加者（Custom Chat Participant）を定義。
- `.github/copilot-instructions.md` ファイルでカスタムチャットモードを設定。
- `@kansai` とメンションすることで、関西弁で応答するフレンドリーなプログラミングアシスタントを利用可能。
- コードの質問や相談に対して、関西弁でわかりやすく親しみやすい回答を提供。
- 技術的な正確性を保ちつつ、「せやな」「ほんまに」「ええで」などの関西弁特有の表現を使用。

### 3.8 テスト自動化

- pytest を使用したユニットテストの実装により、コードの品質を保証。
- Pull Request 作成時・プッシュ時に GitHub Actions で自動的にテストを実行。
- テストカバレッジレポートの生成とアーティファクト保存。
- テスト対象モジュール：
  - stock_loader（銘柄リスト読み込み、多通貨対応の通貨判定、銘柄分類、口座種別管理、課税計算）
  - preference_loader（投資志向性設定読み込み、バリデーション、プロンプト生成）
  - data_fetcher（データ構造検証）
  - report_generator（HTMLレポート生成）
  - mail_utils（メール本文生成、分類別メール本文生成、マークダウン変換）
  - ai_analyzer（保有状況プロンプト生成、多通貨対応の損益計算、口座種別を考慮した税引後損益計算）
  - validate_stocks（stocks.yamlのバリデーション）
  - format_yaml（YAMLファイルの自動フォーマット、コメント保持、インデント修正）
- CI/CD パイプラインでテストが失敗した場合、マージをブロック。
- GitHub Copilot Premium の消費を節約しつつ、コード品質を維持。

### 3.9 stocks.yamlバリデーション機能

- `data/stocks.yaml` ファイルの形式を自動的に検証し、不正なデータの混入を防止。
- GitHub Actions により、dataフォルダ内のファイルが更新されるたびに自動実行。
- 検証項目：
  - YAML構文の正確性
  - 必須フィールド（`symbol`）の存在確認
  - `symbol`フィールドは文字列または数値（整数）を許可
  - フィールドの型チェック（`quantity`、`acquisition_price`は数値、など）
  - 値の範囲チェック（`acquisition_price`は正の数、など）
  - `account_type`の有効値チェック（'特定'、'NISA'、'旧NISA'）
  - `considering_action`の有効値チェック（'buy'、'short_sell'）
  - 後方互換性（文字列形式の銘柄リストもサポート）
- バリデーションエラー時は詳細なエラーメッセージを表示し、問題箇所を明示。
- Pull Request作成時にバリデーションが失敗した場合、マージをブロック。

### 3.10 投資志向性設定機能

- ユーザーの投資に対する志向性を独立した設定ファイル（`data/investment_preferences.yaml`）で管理。
- 投資スタイル、リスク許容度、投資期間、売買頻度、重視する指標などを設定可能。
- 設定内容はAI分析時のプロンプトに含まれ、個人の投資方針に合わせた分析を提供。
- テンプレートと選択肢を明示し、初見のユーザーでも迷わずに設定可能。
- バリデーション機能により、設定ファイルの形式を自動検証。
- GitHub Actionsにより、設定ファイル更新時に自動でバリデーションを実行。
- 設定項目：
  - **投資スタイル** (`investment_style`): growth（成長投資）、value（バリュー投資）、income（インカムゲイン投資）、balanced（バランス投資）、speculative（投機的投資）
  - **リスク許容度** (`risk_tolerance`): low（低リスク）、medium（中リスク）、high（高リスク）
  - **投資期間** (`investment_horizon`): short（短期）、medium（中期）、long（長期）
  - **売買頻度** (`trading_frequency`): high（頻繁）、medium（適度）、low（少ない）
  - **重視する指標** (`focus_areas`): technical（テクニカル分析）、fundamental（ファンダメンタル分析）、news（ニュース）、dividend（配当）、momentum（モメンタム）から複数選択
  - **カスタムメッセージ** (`custom_message`): 追加の要望を自由記述
- デフォルト設定が用意されており、ファイルが存在しない場合はデフォルト値（balanced、medium、medium、medium、[fundamental, news]）を使用。
- 設定変更は次回の分析実行時から自動的に反映される。

### 3.11 YAML自動フォーマット機能

- `data/` ディレクトリ以下のYAMLファイルを自動的にフォーマットし、インデントのズレを修正。
- スマートフォンから編集した際のインデント不整合を自動で修正。
- GitHub Actions により、Pull RequestおよびMainブランチへのPush時に自動実行。
- `ruamel.yaml`ライブラリを使用し、コメントと引用符を保持したままフォーマット。
- フォーマット対象：`data/` ディレクトリ内の `.yaml`, `.yml` ファイル

**詳細な使用方法**: <a>README.md</a> を参照してください。

### 3.12 GitHub Copilot Premium の効率的な利用

- GitHub Copilot への明確な指示により、不要な処理を抑制し、Premium消費を節約。
- テスト自動化（pytest + GitHub Actions）の活用により、手動テスト実施を最小化。
- 既存ドキュメントの優先的な更新により、実用性の低いドキュメントファイルの作成を回避。
- 要件定義書の更新は必須としつつ、その他のドキュメント作成は実用性が明確な場合のみ実施。
- 最小限の変更と既存コードの再利用により、作業効率を最大化。
- 自動化ワークフロー（テスト、ビルド、デプロイ、自動マージ、YAML自動フォーマット）の活用により、手動作業を削減。

## 4. 非機能要件

- セキュリティ：API キーや個人情報の安全な管理（.env, Secrets, BCC 運用等）。
- パフォーマンス：日次処理が 1 時間以内に完了すること。
- 拡張性：銘柄追加や分析ロジックの拡張が容易。銘柄リストはYAML形式で管理し、スマートフォンからも編集可能。銘柄ごとに追加メタデータを柔軟に管理可能。
- 保守性：設定や運用が容易で、モジュール分割・関数化されていること。銘柄の変更履歴を Git で管理。
- 多市場・多通貨対応：日本株（円）、米国株（ドル）、欧州株（ユーロ）など、複数の市場と通貨に対応可能な設計。

## 5. システム構成

### 5.1 モジュール構成

システムはAPI別・機能別にモジュール化されており、単一責任の原則に従って設計されています。

#### コアモジュール（src/）

- **main.py**：メインエントリーポイント。各モジュールを組み合わせたオーケストレーション処理。全体のワークフローを制御し、データ取得・分析・レポート生成・メール配信の一連の処理を統合する。
- **config.py**：環境変数の読み込みと設定値の一元管理。API キー、メール設定、モデル名などのシステム設定を管理する。
- **stock_loader.py**：YAML銘柄リストの読み込み、通貨判定、銘柄分類機能。銘柄データの読み込みと保有状況に基づく分類（保有中、空売り中、購入検討中）を担当する。
- **preference_loader.py**：投資志向性設定の読み込みとプロンプト生成。YAML形式の投資志向性設定ファイルを読み込み、AI分析用のプロンプト文字列を生成する。
- **validate_stocks.py**：stocks.yamlファイルのバリデーションスクリプト。YAML構文、必須フィールド、型、値の範囲などを検証し、不正なデータの混入を防止する。
- **validate_preferences.py**：investment_preferences.yamlファイルのバリデーションスクリプト。投資志向性設定の形式を検証し、不正な設定値の混入を防止する。
- **format_yaml.py**：YAMLファイルの自動フォーマットスクリプト。インデントのズレを修正し、コメントを保持したままフォーマット。`--check` オプションでフォーマットが必要かチェックのみ可能。
- **data_fetcher.py**：Yahoo Finance APIとdefeatbeta-apiによるデータ取得。株価データとニュースデータの取得を担当し、外部APIとの通信を抽象化する。
- **ai_analyzer.py**：Claude API/Gemini APIによる分析処理と保有状況プロンプト生成。取得したデータと投資志向性設定を基にAIで分析を実施し、売買判断と推奨価格を含むレポートを生成する。
- **report_generator.py**：HTMLレポート生成とファイル保存。分析結果をHTML形式に変換し、ファイルとして保存する。ホールド判断時の簡略化ロジックを含む。
- **report_simplifier.py**：レポート簡略化モジュール。ホールド判断の検出とレポートの簡略化を担当する。
- **mail_utils.py**：メール送信・SMTP 設定・分類別メール本文生成のユーティリティ。メール配信機能を提供し、保有状況に応じて分類されたメール本文を生成する。

#### データ・設定ファイル

- **data/stocks.yaml**：分析対象銘柄リスト（YAML形式、Git で変更履歴管理）
- **data/investment_preferences.yaml**：投資志向性設定ファイル（YAML形式、Git で変更履歴管理）
- **requirements.txt**：依存パッケージ管理
- **.env/.env.example**：環境変数テンプレート

#### GitHub Actions・設定

- **.github/workflows/report.yml**：自動実行ワークフロー
- **.github/workflows/auto-merge.yml**：PR 承認時の自動マージワークフロー
- **.github/workflows/test.yml**：テスト自動実行ワークフロー
- **.github/workflows/copilot-setup-steps.yml**：GitHub Copilot用セットアップワークフロー
- **.github/workflows/validate-stocks.yml**：stocks.yamlバリデーション自動実行ワークフロー
- **.github/workflows/validate-preferences.yml**：investment_preferences.yamlバリデーション自動実行ワークフロー
- **.github/workflows/format-yaml.yml**：YAML自動フォーマットワークフロー
- **.github/actions/setup-python-env**：Python環境セットアップ用の再利用可能アクション（NLTKデータ・defeatbeta-apiデータの事前ダウンロード処理を集約）
- **.github/copilot-instructions.md**：VS Code 用カスタムチャットモード定義

**Note**: report.yml、test.yml、copilot-setup-steps.ymlは、setup-python-envアクションを使用してファイアウォール対策を実施しています（詳細は9.1節を参照）。

#### テスト（tests/）

テストの詳細については <a>docs/TEST.md</a> を参照してください。

### 5.2 モジュール間の関係

```
main.py (オーケストレーション)
  ├── config.py (設定管理)
  ├── stock_loader.py (銘柄データ読み込み)
  ├── preference_loader.py (投資志向性設定読み込み)
  ├── data_fetcher.py (外部API: Yahoo Finance, defeatbeta-api)
  │     └── config.py
  ├── ai_analyzer.py (AI分析: Claude, Gemini)
  │     ├── config.py
  │     ├── stock_loader.py
  │     └── preference_loader.py (投資志向性プロンプト生成)
  ├── report_generator.py (レポート生成)
  │     ├── mail_utils.py
  │     └── report_simplifier.py (ホールド判断検出・簡略化)
  ├── report_simplifier.py (レポート簡略化)
  └── mail_utils.py (メール配信)
```

## 6. 利用技術

- Python（データ収集・分析・レポート生成・メール送信）
- anthropic（Claude Sonnet API 公式パッケージ）
- defeatbeta-api（市場ニュースデータ取得）
- PyYAML（YAML ファイルの解析）
- ruamel.yaml（コメント保持可能なYAMLフォーマッター）
- requests, python-dotenv, smtplib, email, markdown
- pytest, pytest-cov（テストフレームワーク・カバレッジ測定）
- GitHub Actions（スケジューラ・自動化・CI/CD）

## 7. 運用・保守

- エラー通知・ログ出力（print ベース、今後拡張可）
- エラー詳細情報をメール本文に含めることで、GitHub Actions画面を確認せずに原因把握が可能
- API キー・認証情報の安全な管理
- モデル EOL や API 仕様変更時の迅速な対応
- モジュール分割により、各機能の独立したテスト・保守が可能
- 自動テストによりコード品質を継続的に保証
- Pull Request 作成時の自動テスト実行により、問題を早期発見

## 8. その他

- 法令遵守（金融商品取引法等）
- 利用規約・プライバシーポリシーの整備

## 9. 実行環境

- GitHub Actions 上で定期実行（cron スケジューラ）を行う。
- 実行時刻は JST（日本標準時）で平日（月曜日～金曜日）の午前 9 時 10 分。
- 土日は株式市場が休みのため実行しない。
- Claude Sonnet API キーやメール配信設定等の機密情報は、GitHub リポジトリの「Secrets」で安全に管理する。
- 対象銘柄リストは `data/stocks.yaml` ファイル（YAML形式）で管理し、Git で変更履歴を追跡する。
- レポート生成・配信処理も Actions workflow で自動化する。

**環境変数の詳細はREADME.mdを参照してください。**

### 9.1 ファイアウォール対策

GitHub Copilotがワークフロー内でpytestなどのコマンドを実行する際、ファイアウォールルールによって外部ネットワークへのアクセスが制限されます。本システムでは、`.github/actions/setup-python-env`という再利用可能なComposite Actionを使用して、以下の対策を実施しています：

- **NLTKデータの事前ダウンロード**：defeatbeta-apiが依存するnltkパッケージのデータをファイアウォール有効化前にダウンロード
- **defeatbeta-apiデータの事前ダウンロード**：huggingface.coからの株式データ情報を事前取得
- **キャッシュ機能の活用**：2回目以降のワークフロー実行を高速化

このアクションは複数のワークフロー（test.yml、report.yml、copilot-setup-steps.yml）から参照されており、メンテナンス性が向上しています。

**詳細な実装内容・使用方法・トラブルシューティングについては、[setup-python-envアクションのREADME](../../actions/setup-python-env/README.md)を参照してください。**

## 10. 銘柄リスト管理

- 銘柄リストは `data/stocks.yaml` ファイル（YAML形式）で管理。
- 構造化されたデータ形式で、銘柄ごとに以下の情報を管理可能：
  - `symbol`（必須）: 銘柄コード（文字列または数値）
    - 文字列形式：'7203.T'、'AAPL'など
    - 数値形式：7203、6758など（4桁数値は自動的に`.T`サフィックスが追加され日本株として扱われる）
  - `name`（任意）: 企業名。レポートの見出しに使用される。未設定の場合は銘柄コードが使用される。
  - `added`（任意）: 追加日
  - `note`（任意）: メモ・注記
  - `quantity`（任意）: 保有数（プラスは保有、マイナスは空売り、未設定は購入検討中）
  - `acquisition_price`（任意）: 取得単価（購入価格または空売り価格）
  - `currency`（任意）: 通貨単位（円、ドル、ユーロ、ポンドなど）。未設定の場合は銘柄シンボルから自動判定（4桁数値は円と判定）
  - `account_type`（任意）: 口座種別（'特定'/'NISA'/'旧NISA'、デフォルトは'特定'）
    - **特定**: 譲渡益に20.315%課税
    - **NISA**: 非課税
    - **旧NISA**: 非課税
- YAMLのコメント機能（`#` で始まる行）を使用可能。
- Git で変更履歴を管理できるため、いつ・誰が・どの銘柄を追加/削除したか追跡可能。
- スマートフォンのブラウザからも GitHub の Web インターフェースで簡単に編集可能。
- 将来的に銘柄ごとの追加設定（アラート閾値、分析頻度など）を柔軟に追加可能。

**銘柄リストの編集方法の詳細はREADME.mdを参照してください。**

## 11. 売買タイミング分析機能

- 銘柄の保有状況（保有数、取得単価）を設定することで、AI が保有状況を考慮した売買判断を提供。
- 保有数の解釈：
  - 正の数（例: 100）: 保有中の銘柄として、売却タイミングや買い増しの判断を提供
  - 負の数（例: -50）: 空売り中（信用売り）として、買戻しタイミングの判断を提供
  - 未設定: 購入または空売りを検討中として、新規エントリーのタイミングを提供
- 取得単価を設定すると、現在の株価との比較で損益を計算し、具体的な指値価格を提案。
- AI 分析には以下の情報が含まれる：
  - 現在の損益状況（取得単価が設定されている場合）
  - 売買判断（買い/買い増し/売り/ホールド/様子見）とその理由
  - 推奨する指値価格（買い注文または売り注文）
  - 保有状況を考慮した具体的な売買アクション（保有中銘柄については買い増しも含む）

## 12. 口座種別による課税計算機能

- 銘柄ごとに口座種別を設定可能（'特定'/'NISA'/'旧NISA'）。デフォルトは'特定'。
- 口座種別に応じた課税処理：
  - **特定口座**: 譲渡益に対して20.315%（所得税15.315% + 住民税5%）を課税
  - **NISA口座**: 非課税（税額0円）
  - **旧NISA口座**: 非課税（税額0円）
- AI分析レポートには以下の情報が含まれる：
  - 現在の損益（税引前）
  - 税額（特定口座で利益が出ている場合のみ）
  - 税引後損益（利益・損失を考慮した実質的な損益）
  - 口座種別の表示
- 損失が出ている場合は課税対象外のため、税額は表示されない。
- 投資判断の材料として、税金を考慮した実質的な損益を確認可能。

---

（本要件定義書は現行のモジュール化されたシステム設計・実装内容に基づき、今後の議論・運用により随時更新します）
