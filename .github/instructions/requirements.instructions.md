# 要件定義書

## 1. システム概要

銘柄株の動向やトレンドを Claude Sonnet（AI）で日次に調査・分析し、HTML レポートとして自動生成・メール配信するシステム。

## 2. 目的

- 投資判断の材料となる情報を自動で収集・分析し、分かりやすいレポートとして提供する。
- 日々の株式市場の変化を迅速に把握できるようにする。

## 3. 機能要件

### 3.1 データ収集

- 対象銘柄リストはリポジトリ内の `data/stocks.yaml` ファイル（YAML形式）で管理。
- デフォルト値: '7203.T,6758.T'（ファイルが存在しない場合）
- 日本株（.T、.JP サフィックス）と米国株の両方に対応。
- 株価データを Yahoo Finance API（RapidAPI 経由）から日次で自動取得する。
- ニュースデータは defeatbeta-api を使用して実際のニュースを取得（最大5件）。
- 銘柄リストはYAML形式で管理し、銘柄コード、企業名、追加日、メモなどを構造化して記録可能。

### 3.2 AI 分析

- Claude Sonnet API（最新モデル: claude-3-sonnet-latest など）または Gemini API を用いて、収集データの動向・トレンド・リスク/チャンスを日本語で要約・分析する。
- API キー・モデル名は環境変数で管理。
- 銘柄シンボルから市場を自動判定し、適切な通貨（円/ドル）で分析を実施。
  - 日本株（.T、.JP サフィックス）→「円」
  - 米国株など → 「ドル」
- エラー発生時は、詳細なエラーメッセージ（例外内容、HTTPステータスコード、API応答など）をマークダウン形式で返し、メール本文に含める。

### 3.3 レポート生成

- 分析結果を HTML 形式で日次レポートとして自動生成。
- レポートは 1 銘柄ごとに HTML ファイルとして保存し、全銘柄分をまとめてメール本文にも埋め込む。
- 分析エラー発生時は、エラーメッセージをHTML形式でレポートに含める。

### 3.4 メール配信

- SMTP サーバ設定・送信元・宛先アドレス等は環境変数で管理。
- 複数宛先対応（カンマ・セミコロン区切り、またはリスト）。
- すべての宛先は BCC で送信し、受信者間でアドレスが見えないよう配慮。
- メール本文は HTML 形式。

### 3.5 スケジューラ・自動化

- GitHub Actions 等の CI/CD で日次自動実行が可能。
- .env や Secrets で安全に API キー・認証情報を管理。
- 対象銘柄リストはリポジトリ内の `data/stocks.yaml` ファイル（YAML形式）で管理し、Git で変更履歴を追跡。

### 3.6 自動マージ機能

- GitHub Copilot が作成した Pull Request を承認（Approve）すると、自動的にマージされる。
- マージ方式はスカッシュマージ（Squash Merge）を採用し、コミット履歴を整理。
- マージ後、自動的にブランチを削除してリポジトリを整理。
- GitHub Actions の `pull_request_review` イベントをトリガーとして実行。

### 3.7 カスタムチャットモード

- VS Code の GitHub Copilot で使用可能なカスタムチャット参加者（Custom Chat Participant）を定義。
- `.github/copilot-instructions.md` ファイルでカスタムチャットモードを設定。
- `@kansai` とメンションすることで、関西弁で応答するフレンドリーなプログラミングアシスタントを利用可能。
- コードの質問や相談に対して、関西弁でわかりやすく親しみやすい回答を提供。
- 技術的な正確性を保ちつつ、「せやな」「ほんまに」「ええで」などの関西弁特有の表現を使用。

## 4. 非機能要件

- セキュリティ：API キーや個人情報の安全な管理（.env, Secrets, BCC 運用等）。
- パフォーマンス：日次処理が 1 時間以内に完了すること。
- 拡張性：銘柄追加や分析ロジックの拡張が容易。銘柄リストはYAML形式で管理し、スマートフォンからも編集可能。銘柄ごとに追加メタデータを柔軟に管理可能。
- 保守性：設定や運用が容易で、モジュール分割・関数化されていること。銘柄の変更履歴を Git で管理。
- 多市場対応：日本株と米国株など、複数の市場に対応可能な設計。

## 5. システム構成

- main.py：データ収集・AI 分析・レポート生成・配信の統括
- mail_utils.py：メール送信・SMTP 設定・本文生成のユーティリティ
- data/stocks.yaml：分析対象銘柄リスト（YAML形式、Git で変更履歴管理）
- requirements.txt：依存パッケージ管理
- .env/.env.example：環境変数テンプレート
- .github/workflows/report.yml：自動実行ワークフロー
- .github/workflows/auto-merge.yml：PR 承認時の自動マージワークフロー
- .github/copilot-instructions.md：VS Code 用カスタムチャットモード定義
- .github/copilot-instructions.md：VS Code 用カスタムチャットモード定義

## 6. 利用技術

- Python（データ収集・分析・レポート生成・メール送信）
- anthropic（Claude Sonnet API 公式パッケージ）
- defeatbeta-api（市場ニュースデータ取得）
- PyYAML（YAML ファイルの解析）
- requests, python-dotenv, smtplib, email, markdown
- GitHub Actions（スケジューラ・自動化）

## 7. 運用・保守

- エラー通知・ログ出力（print ベース、今後拡張可）
- エラー詳細情報をメール本文に含めることで、GitHub Actions画面を確認せずに原因把握が可能
- API キー・認証情報の安全な管理
- モデル EOL や API 仕様変更時の迅速な対応

## 8. その他

- 法令遵守（金融商品取引法等）
- 利用規約・プライバシーポリシーの整備

## 9. 実行環境

- GitHub Actions 上で定期実行（cron スケジューラ）を行う。
- 実行時刻は JST（日本標準時）で平日（月曜日～金曜日）の午前 9 時 10 分。
- 土日は株式市場が休みのため実行しない。
- Claude Sonnet API キーやメール配信設定等の機密情報は、GitHub リポジトリの「Secrets」で安全に管理する。
- 対象銘柄リストは `data/stocks.yaml` ファイル（YAML形式）で管理し、Git で変更履歴を追跡する。
- レポート生成・配信処理も Actions workflow で自動化する。

## 10. 環境変数

| 変数名           | 種類     | 用途                                   | デフォルト値      |
| ---------------- | -------- | -------------------------------------- | ----------------- |
| `CLAUDE_API_KEY` | Secret   | Claude Sonnet API キー                 | なし（必須）      |
| `GEMINI_API_KEY` | Secret   | Gemini API キー                        | なし（必須）      |
| `YAHOO_API_KEY`  | Secret   | Yahoo Finance API キー                 | なし（必須）      |
| `MAIL_TO`        | Secret   | レポート送信先メールアドレス           | なし（必須）      |
| `MAIL_FROM`      | Secret   | 送信元メールアドレス                   | なし（必須）      |
| `SMTP_SERVER`    | Secret   | SMTP サーバー                          | なし（必須）      |
| `SMTP_PORT`      | Secret   | SMTP ポート                            | なし（必須）      |
| `SMTP_USER`      | Secret   | SMTP 認証ユーザー                      | なし（必須）      |
| `SMTP_PASS`      | Secret   | SMTP 認証パスワード                    | なし（必須）      |

## 11. 銘柄リスト管理

- 銘柄リストは `data/stocks.yaml` ファイル（YAML形式）で管理。
- 構造化されたデータ形式で、銘柄ごとに以下の情報を管理可能：
  - `symbol`（必須）: 銘柄コード
  - `name`（任意）: 企業名
  - `added`（任意）: 追加日
  - `note`（任意）: メモ・注記
  - `quantity`（任意）: 保有数（プラスは保有、マイナスは空売り、未設定は購入検討中）
  - `acquisition_price`（任意）: 取得単価（購入価格または空売り価格）
- YAMLのコメント機能（`#` で始まる行）を使用可能。
- Git で変更履歴を管理できるため、いつ・誰が・どの銘柄を追加/削除したか追跡可能。
- スマートフォンのブラウザからも GitHub の Web インターフェースで簡単に編集可能。
- 将来的に銘柄ごとの追加設定（アラート閾値、分析頻度など）を柔軟に追加可能。

## 12. 売買タイミング分析機能

- 銘柄の保有状況（保有数、取得単価）を設定することで、AI が保有状況を考慮した売買判断を提供。
- 保有数の解釈：
  - 正の数（例: 100）: 保有中の銘柄として、売却タイミングや追加購入の判断を提供
  - 負の数（例: -50）: 空売り中（信用売り）として、買戻しタイミングの判断を提供
  - 未設定: 購入または空売りを検討中として、新規エントリーのタイミングを提供
- 取得単価を設定すると、現在の株価との比較で損益を計算し、具体的な指値価格を提案。
- AI 分析には以下の情報が含まれる：
  - 現在の損益状況（取得単価が設定されている場合）
  - 売買判断（買い/売り/ホールド/様子見）とその理由
  - 推奨する指値価格（買い注文または売り注文）
  - 保有状況を考慮した具体的な売買アクション

---

（本要件定義書は現行の main.py・mail_utils.py の設計・実装内容に基づき、今後の議論・運用により随時更新します）
