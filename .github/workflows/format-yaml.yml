name: Auto Format YAML

on:
  pull_request:
    paths:
      - 'data/**/*.yaml'
      - 'data/**/*.yml'
  push:
    branches: [ main ]
    paths:
      - 'data/**/*.yaml'
      - 'data/**/*.yml'

jobs:
  format:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install ruamel.yaml
      
      - name: Format YAML files
        id: format
        run: |
          echo "formatted_files=" >> $GITHUB_OUTPUT
          formatted=false
          
          for file in data/*.yaml data/*.yml; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              python src/formatters/format_yaml.py "$file"
            fi
          done
          
          # å®Ÿéš›ã«å¤‰æ›´ãŒã‚ã£ãŸã‹ã‚’git diffã§ç¢ºèª
          # å‡¦ç†ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹
          yaml_files_list=$(find data/ -maxdepth 1 -type f \( -name "*.yaml" -o -name "*.yml" \))
          if [ -n "$yaml_files_list" ] && echo "$yaml_files_list" | xargs git diff --quiet --; then
            echo "âœ“ å¤‰æ›´ãªã—"
          else
            formatted=true
            changed_files=$(echo "$yaml_files_list" | xargs git diff --name-only -- | paste -sd ' ' -)
            echo "formatted_files=${changed_files}" >> $GITHUB_OUTPUT
            echo "âœ… å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: ${changed_files}"
          fi
          
          echo "formatted=$formatted" >> $GITHUB_OUTPUT
      
      - name: Commit formatted files
        if: steps.format.outputs.formatted == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          git commit -m "ðŸ”§ è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ: YAMLãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä¿®æ­£"
          git push
      
      - name: Format Summary
        if: always()
        run: |
          echo "## YAMLè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆçµæžœ ðŸ”§" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.format.outputs.formatted }}" = "true" ]; then
            echo "âœ… ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå®Œäº†: ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.format.outputs.formatted_files }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ“ ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆä¸è¦: ã™ã¹ã¦ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã¯æ­£ã—ã„å½¢å¼ã§ã™" >> $GITHUB_STEP_SUMMARY
          fi
