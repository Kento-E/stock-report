name: Auto Format YAML

on:
  pull_request:
    paths:
      - 'data/**/*.yaml'
      - 'data/**/*.yml'
  push:
    branches: [ main ]
    paths:
      - 'data/**/*.yaml'
      - 'data/**/*.yml'

jobs:
  format:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install ruamel.yaml
      
      - name: Format YAML files
        id: format
        run: |
          echo "formatted_files=" >> $GITHUB_OUTPUT
          formatted=false
          
          for file in data/*.yaml data/*.yml; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              if python src/formatters/format_yaml.py "$file"; then
                echo "  âœ“ Formatted: $file"
                formatted=true
                echo "formatted_files=$file " >> $GITHUB_OUTPUT
              else
                echo "  - No changes: $file"
              fi
            fi
          done
          
          echo "formatted=$formatted" >> $GITHUB_OUTPUT
      
      - name: Commit formatted files
        if: steps.format.outputs.formatted == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          git commit -m "ðŸ”§ è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ: YAMLãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä¿®æ­£"
          git push
      
      - name: Format Summary
        if: always()
        run: |
          echo "## YAMLè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆçµæžœ ðŸ”§" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.format.outputs.formatted }}" = "true" ]; then
            echo "âœ… ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå®Œäº†: ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.format.outputs.formatted_files }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ“ ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆä¸è¦: ã™ã¹ã¦ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã¯æ­£ã—ã„å½¢å¼ã§ã™" >> $GITHUB_STEP_SUMMARY
          fi
