name: Auto Merge on Approval

on:
  pull_request_review:
    types: [submitted]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # PRが承認され、かつ承認者がリポジトリのメンバーである場合のみ実行
    if: github.event.review.state == 'approved'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Auto merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "PR #${PR_NUMBER} が承認されました。自動マージを開始します..."

          # PRが既にマージ済みかどうかをチェック
          PR_STATE=$(gh pr view ${PR_NUMBER} --json state --jq '.state')

          if [ "$PR_STATE" = "MERGED" ]; then
            echo "✅ このPRは既にマージ済みです。自動マージ処理をスキップします。"
            exit 0
          fi

          # PRがDraftかどうかをチェック
          IS_DRAFT=$(gh pr view ${PR_NUMBER} --json isDraft --jq '.isDraft')

          if [ "$IS_DRAFT" = "true" ]; then
            echo "⚠️ このPRはDraft状態です。Draft状態のPRは自動マージされません。"
            echo "Ready for reviewに変更してから再度Approveしてください。"
            exit 0
          fi

          # 未解決の会話スレッドがあるかチェック
          REVIEW_THREADS=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}/comments" --jq '[.[] | select(.in_reply_to_id == null)] | length')
          RESOLVED_THREADS=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}/comments" --jq '[.[] | select(.in_reply_to_id == null and (.body | contains("```") | not) and (.body | contains("resolved") or .body | contains("Resolved") or .body | contains("RESOLVED")))] | length')
          
          # レビュースレッドの解決状態をチェック（GitHub APIのreviewThreadsエンドポイント使用）
          UNRESOLVED_COUNT=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $number) {
                  reviewThreads(first: 100) {
                    nodes {
                      isResolved
                    }
                  }
                }
              }
            }' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" -F number=${PR_NUMBER} --jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length')

          if [ "$UNRESOLVED_COUNT" -gt 0 ]; then
            echo "⚠️ 未解決の会話スレッドが ${UNRESOLVED_COUNT} 件あります。"
            echo "すべての会話スレッドを解決してから再度Approveしてください。"
            exit 0
          fi

          # 自動マージを有効化（必須チェック完了後に自動的にマージ）
          gh pr merge ${PR_NUMBER} --squash --auto --delete-branch

          echo "✅ PR #${PR_NUMBER} の自動マージを有効化しました"
          echo "必須チェックが完了次第、自動的にマージされます"
