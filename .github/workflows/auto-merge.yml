name: Auto Merge on Approval

on:
  pull_request_review:
    types: [submitted]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # PRが承認され、かつ承認者がリポジトリのメンバーである場合のみ実行
    if: github.event.review.state == 'approved'
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Auto merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REVIEWER: ${{ github.event.review.user.login }}
        run: |
          echo "PR #${PR_NUMBER} が承認されました。自動マージを開始します..."
          echo "PR作成者: ${PR_AUTHOR}"
          echo "承認者: ${REVIEWER}"
          
          # PRが既にマージ済みかどうかをチェック
          PR_STATE=$(gh pr view ${PR_NUMBER} --json state --jq '.state')
          
          if [ "$PR_STATE" = "MERGED" ]; then
            echo "✅ このPRは既にマージ済みです。自動マージ処理をスキップします。"
            exit 0
          fi
          
          # PRがDraftかどうかをチェック
          IS_DRAFT=$(gh pr view ${PR_NUMBER} --json isDraft --jq '.isDraft')
          
          if [ "$IS_DRAFT" = "true" ]; then
            echo "⚠️ このPRはDraft状態です。Draft状態のPRは自動マージされません。"
            echo "Ready for reviewに変更してから再度Approveしてください。"
            exit 0
          fi
          
          # PR作成者による自己承認の場合の特別処理
          if [ "$PR_AUTHOR" = "$REVIEWER" ]; then
            echo "⚠️ PR作成者による自己承認が検出されました"
            echo "GitHubのポリシーにより、自己承認では必須レビュー要件を満たせません"
            echo "コードオーナーが作成したPRの場合は、手動でマージする必要があります"
            echo ""
            echo "対応方法："
            echo "1. 他のコードオーナー（@copilot等）にレビューを依頼する"
            echo "2. または、管理者権限で手動マージを実行してください"
            exit 0
          fi
          
          # 自動マージを有効化（必須チェック完了後に自動的にマージ）
          gh pr merge ${PR_NUMBER} --squash --auto --delete-branch
          
          echo "✅ PR #${PR_NUMBER} の自動マージを有効化しました"
          echo "必須チェックが完了次第、自動的にマージされます"
