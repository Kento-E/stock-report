# エラーメッセージ表示例

この文書は、実装したエラーメッセージ機能がメールでどのように表示されるかを示します。

## メールでの表示例

### ケース1: 正常な分析結果

```
銘柄: 7203.T (トヨタ自動車)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
市場分析

トヨタ自動車の株価は15,234円で、前日比+1.2%の上昇となりました。

トレンド: 上昇トレンドが継続しています...
リスク: 半導体不足の影響に注意が必要です...
チャンス: EV市場への積極投資が評価されています...
```

### ケース2: APIキー未設定エラー

```
銘柄: 6758.T (ソニーグループ)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分析失敗

エラー内容: Gemini APIエラー: APIキーが未設定です。環境変数GEMINI_API_KEYを確認してください。
```

### ケース3: API呼び出しエラー（レート制限）

```
銘柄: AAPL (Apple Inc.)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分析失敗

エラー内容: Claude API呼び出し失敗: Rate limit exceeded. Please try again later.

エラータイプ: RateLimitError
```

### ケース4: HTTPエラー

```
銘柄: MSFT (Microsoft Corporation)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分析失敗

エラー内容: Gemini APIエラー: HTTPステータス 429

API応答: {"error": {"code": 429, "message": "Resource has been exhausted (e.g. check quota).", "status": "RESOURCE_EXHAUSTED"}}
```

### ケース5: 接続エラー

```
銘柄: GOOGL (Alphabet Inc.)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分析失敗

エラー内容: Gemini API呼び出し失敗: HTTPSConnectionPool(host='generativelanguage.googleapis.com', port=443): Max retries exceeded

エラータイプ: ConnectionError
```

## 変更前と変更後の比較

### 変更前
- メールに「分析失敗」とだけ表示される
- エラーの原因を知るにはGitHub Actionsの実行ログを確認する必要がある
- エラーが発生した銘柄と原因を特定するのに時間がかかる

### 変更後（✅ 実装完了）
- エラーの詳細（APIキー未設定、レート制限、接続エラーなど）がメール本文に表示される
- GitHub Actionsの画面を開かずに、メールだけで原因を把握できる
- 即座に適切な対応（APIキー設定、しばらく待つ、ネットワーク確認など）ができる

## 技術的な実装詳細

### エラーメッセージの生成

エラーが発生した場合、以下のマークダウン形式で返されます：

```python
f"## 分析失敗\n\n**エラー内容:** {error_msg}\n\n**エラータイプ:** {type(e).__name__}"
```

### HTML変換

マークダウンは`markdown.markdown()`関数で自動的にHTMLに変換され、メール本文に含まれます：

```html
<h2>分析失敗</h2>
<p><strong>エラー内容:</strong> Claude APIエラー: APIキーが未設定です。</p>
<p><strong>エラータイプ:</strong> ValueError</p>
```

## 対応しているエラータイプ

1. **APIキー未設定** - 環境変数が設定されていない場合
2. **API呼び出し失敗** - ネットワークエラー、タイムアウトなど
3. **HTTPエラー** - 4xx, 5xxレスポンス（ステータスコードとAPI応答を含む）
4. **認証エラー** - 無効なAPIキー
5. **レート制限** - API利用制限超過
6. **その他の例外** - 予期しないエラー（例外タイプを含む）
